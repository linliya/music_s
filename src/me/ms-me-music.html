<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../bower_components/tk-confirm-dialog/tk-confirm-dialog.html">

<link rel="import" href=".././index/ms-topbar.html">
<link rel="import" href=".././behavior/ms-connect-behavior.html">
<link rel="import" href=".././music_disk/ms-disk-detail-list.html">
<link rel="import" href="./ms-create-playlist-dialog.html">

<script src="../../bower_components/moment/moment.js"></script>

<dom-module id="ms-me-music">
  <template>
    <style>
      ul, p, h3 {
        margin: 0;
        padding: 0;
      }

      a {
        text-decoration: none;
        color: #0c73c2;
        font-size: 12px;
      }

      ms-topbar:after {
        content: '';
        display: block;
        border-bottom: 4px solid #11aaff;
      }

      #wrap {
        width: 960px;
        margin: 0px auto;
        border: 1px solid #ccc;
        background: #fff;
        font-size: 14px;
        display: flex;
        justify-content: flex-start;
      }

      #disk {
        width: 240px;
        padding-top: 40px;
        border-right: 1px solid #ccc;
        background: #f9f9f9;
      }

      #disk h3 {
        font-size: 14px;
        padding: 0 10px 12px 15px;
        line-height: 24px;
        display: flex;
        justify-content: space-between;
      }

      #disk i {
        border-color: #ccc transparent transparent;
        border-style: solid dashed dashed;
        border-width: 8px 7px 0;
        display: inline-block;
        margin-right: 4px;
      }

      #disk button {
        width: 55px;
        height: 22px;
        border: none;
        outline: none;
        font-size: 12px;
        color: #515151;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
      }

      #disk button iron-icon {
        width: 14px;
        height: 14px;
        color: #2783ca;
      }

      #disk #create {
        cursor: pointer;
      }

      .items {
        height: 54px;
        font-size: 12px;
        color: #333;
        list-style: none;
        padding-left: 20px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
      }

      .items p {
        margin: -8px 0 0 10px;
        padding: 7px 0;
      }

      .items p.num {
        color: #999;
      }

      .itemName > p{
        width: 160px;
        margin-bottom: -10px;
        text-overflow: ellipsis;
	      overflow: hidden;
        white-space: nowrap;
        word-wrap: normal;
      }

      .itemName iron-icon {
        color: #999;
        width: 16px;
        height: 16px;
        float: right;
        /*display: none;*/
      }

      #detail {
        width: 660px;
        margin: 30px 0 0 30px;
        display: flex;
        justify-content: flex-start;
      }

      #detail #photo img {
        padding: 4px;
        border: 1px solid #ccc;
      }

      #detail #text {
        margin-left: 20px;
      }

      #detail h3, #list h3 {
        font-size: 20px;
        color: #333;
        font-weight: normal;
        display: flex;
        align-items: center;
      }

      #text h3 i {
        display: inline-block;
        width: 54px;
        height: 26px;
        background: url('../../images/icons.png') no-repeat 0 -242px;
        padding-right: 8px;
      }

      #author {
        margin: 10px 0 20px;
        display: flex;
        align-items: center;
      }

      #author a {
        padding-left: 10px;
      }

      #author span {
        color: #999;
        font-size: 12px;
        padding-left: 10px;
      }

      #text button {
        width: 66px;
        height: 32px;
        color: #fff;
        border-radius: 4px;
        background: #2475c3;
        border: none;
        outline: none;
        border: 1px solid #2475c3;
        cursor: pointer;
        display: flex;
        align-items: center;
      }

      #text #play:hover {
        background: #2179d0;
      }

      #text button i {
        display: inline-block;
        width: 18px;
        height: 18px;
        margin-right: 4px;
        background: url('../../images/icon.png') no-repeat 0px -59px;
      }

      #list {
        width: 660px;
        padding: 30px;
      }

      #list h3 {
        border-bottom: 2px solid #2783ca;
        padding-bottom: 2px;
      }

      #list h3 span {
        font-size: 13px;
        color: #666;
        margin: 0 0  -8px 20px;
      }

      #content {
        line-height: 24px;
        text-align: center;
        margin-top: 100px;
      }

      #diskList {
        padding: 30px;
      }

      #tag {
        margin-top: 20px;
        color: #666;
        display: flex;
      }

      #tag span {
        line-height: 32px;
      }

      #tag button {
        width: 80px;
        border: none;
        outline: none;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 20px;
        margin-left: 8px;
        color: #666;
        display: flex;
        justify-content: center;
        margin-left: 10px;
      }

      #intro {
        margin: 50px 0 100px 0;
      }

      #intro p {
        color: #666;
      }

    </style>

    <iron-ajax
      id="ajaxGex"
      headers="[[authHeader]]"
      login-user="[[loginUser]]"
      last-response="{{data}}"
      url="[[serverUrl]]/store/[[loginUser.id]]"
      on-response="handleResponse"></iron-ajax>

    <iron-ajax
      id="ajaxDel"
      method="DELETE"
      headers="[[authHeader]]"
      login-user="[[loginUser]]"
      url="[[serverUrl]]/store/delete/[[selectedItem.id]]"
      on-response="handleDeleteResponse"></iron-ajax>

    <ms-topbar user="[[user]]"></ms-topbar>
    <div id="wrap">
      <!-- 左边 -->
      <section id="disk">
        <h3>
          <div>
            <i></i>
            <span>我的歌单([[playlistNum]])</span>
          </div>

          <button type="button" name="button" id="create" on-tap="_create">
            <iron-icon icon="add"></iron-icon>
            新建
          </button>
        </h3>

        <iron-selector attr-for-selected="data-path" selected="{{path}}" id="selector">
            <template is="dom-repeat" items="[[data]]">
              <a href$="/me/music/[[item.result.id]]" data-path$="/me/music/[[item.result.id]]" class="items" on-tap="_getSelectedItem">
                <img hidden$="[[!item.result.creator.backgroundUrl]]" src="[[item.result.creator.backgroundUrl]]" width="40px" height="40px">
                <img hidden$="[[item.result.creator.backgroundUrl]]" src="../../images/my_disk.jpg" width="40px" height="40px">

                <div class="itemName">
                  <p>[[item.result.name]]</p>
                  <p class="num" hidden$="[[item.result.tracks.length]]">
                    <span>0首</span>
                     <iron-icon icon="delete" on-tap="delete"></iron-icon>
                  </p>
                  <p class="num" hidden$="[[!item.result.tracks.length]]">
                    <span>[[item.result.tracks.length]]首</span>
                     <iron-icon icon="delete" on-tap='delete'></iron-icon>
                  </p>

                </div>
              </a>
            </template>
         </iron-selector>

      </section>
      <!-- 右边 -->
      <div >
        <section id="detail">
          <div id="photo">

            <img hidden$="[[!selectedItem.result.coverImgUrl]]" src="[[selectedItem.result.coverImgUrl]]" alt="" width="188px" height="188px">
            <img hidden$="[[selectedItem.result.coverImgUrl]]" src="../../images/my_disk_big.jpg" alt="" width="188px" height="188px">

          </div>

          <div id="text">
            <h3 id="name">
              <i></i>[[selectedItem.result.name]]
            </h3>

            <div>
              <p id="author">

                <img hidden$="[[!selectedItem.result.creator.backgroundUrl]]" src="[[selectedItem.result.creator.backgroundUrl]]" width="35px" height="35px">
                <img hidden$="[[selectedItem.result.creator.backgroundUrl]]" src="../../public/uploads/[[loginUser.id]].png" width="35px" height="35px">

                <a href="#">[[selectedItem.creator.name]]</a>
                <span>[[createTime]] 创建</span>
              </p>
              <button id="play" type="button" name="button">
                <i></i>
                播放
              </button>

              <div id="tag" hidden$="[[!selectedItem.result.tags]]">
                <span>标签:</span>
                <template is="dom-repeat" items="[[selectedItem.result.tags]]">
                  <button>[[item]]</button>
                </template>
              </div>

              <section id="intro">
                <template is="dom-repeat" items="[[description]]">
                  <p>[[item]]</p>
                </template>
              </section>
            </div>
          </div>
        </section>

        <section id="list" hidden$="[[selectedItem.result.tracks]]">
          <h3>
            歌曲列表
            <span>0首歌</span>
          </h3>

          <section id="content" >
            <p>暂无音乐</p>
            马上去<a href="/main">发现音乐</a>
          </section>
        </section>

        <div id="diskList" hidden$="[[!selectedItem.result.tracks]]">
          <ms-disk-detail-list list="[[selectedItem.result.tracks]]" play-count="[[selectedItem.result.playCount]]"></ms-disk-detail-list>
        </div>
      </div>
    </div>
    <ms-create-playlist-dialog id="dialog" login-user="[[loginUser]]"></ms-create-playlist-dialog>
    <tk-confirm-dialog id="confirmDialog"
                       close-by-cancel
                       title="确认删除？"
                       on-tk-confirm-dialog-confirm="_dealConfirm">
    </tk-confirm-dialog>
  </template>
  <script>
    Polymer({
      is: 'ms-me-music',
      behaviors: [Polymer.msConnectBehavior],
      properties: {
        playlistNum: {
          type: Number,
          notify: true,
          value: 0
        },

        selectedItem: {
          type: Object,
          notify: true,
          observer: '_observeSelectedItem'
        },

        createTime: {
          type: String,
          notify: true,
          computed: '_computeCreateTime(selectedItem)'
        }
      },

      attached() {
        this.refresh();
        
        this.addEventListener('ms-create-playlist-success', () => {
          this.refresh();
        });
      },

      refresh() {
        this.$.ajaxGex.generateRequest();
      },

      handleResponse() {
        this.playlistNum = this.data.length;
        this.selectedItem = this.data[0];
      },

      _create() {
        this.$.dialog.open();
      },

      _computeCreateTime(selectedItem){
        if (!selectedItem) {
          return;
        }

        let ctime = selectedItem.result.createTime;
        let formatTime = window.moment(ctime).format('YYYY-MM-DD');
        return formatTime;
      },

      _getSelectedItem(e) {
        let id = window.location.href;
        let split = id.split('/');
        let selectedId = split[split.length - 1];

        for(let i = 0; i < this.data.length; i++) {
          if(this.data[i].result.id == selectedId) {
            this.selectedItem = this.data[i];
            break;
          }
        }
      },

      delete() {
        this.$.confirmDialog.opened = true;
      },

      _dealConfirm() {
        this.$.ajaxDel.generateRequest();
      },

      _observeSelectedItem() {

      },

      handleDeleteResponse() {
        this.refresh();
        this.$.confirmDialog.opened = false;
      }
    });
  </script>
</dom-module>
