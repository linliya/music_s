<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/tk-app-local-user/tk-app-local-user.html">

<link rel="import" href="./ms-main.html">
<link rel="import" href=".././me/ms-me.html">
<link rel="import" href=".././music_detail/ms-music-detail.html">
<link rel="import" href=".././music_disk/ms-disk-detail.html">
<link rel="import" href=".././toplist/ms-toplist.html">
<link rel="import" href=".././playlist/ms-playlist.html">
<link rel="import" href=".././search/ms-search.html">
<link rel="import" href=".././index/ms-player.html">

<dom-module id="ms-app">
  <template>
    <style>
      :host {
        display: block;
        font-family: "Microsoft Yahei";
      }
      #player {
        display: none;
      }
    </style>
    <app-location id="location" path="{{path}}" route="{{route}}"></app-location>

    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{tail}}">
    </app-route>
    <tk-app-local-user id="localUser"></tk-app-local-user>

    <iron-pages attr-for-selected="id" selected="[[routeData.page]]" id="selector">
      <ms-main route="{{tail}}" id="main" login-user="[[user]]"></ms-main>
      <ms-me route="{{tail}}" id="me" login-user="[[user]]"></ms-me>
      <ms-music-detail id="musicDetail" login-user="[[user]]"></ms-music-detail>
      <ms-disk-detail id="diskDetail" login-user="[[user]]"></ms-disk-detail>
      <ms-toplist id="toplist" login-user="[[user]]"></ms-toplist>
      <ms-playlist id="playlist" login-user="[[user]]"></ms-playlist>
      <ms-search id="search" login-user="[[user]]"></ms-search>
    </iron-pages>

    <ms-player id="player"></ms-player>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'ms-app',

        properties: {
          /**
           * 是否存在登录用户
           */
          user: {
            type: Object
          },

          /**
           * 路由。
           */
          route: {
            type: Object,
            notify: true
          },

          /**
           * 路由数据。
           */
          routeData: {
            type: Object,
            notify: true
          },

          /**
           * 路由尾巴。
           */
          tail: {
            type: Object,
            notify: true
          },

          /**
           * App当前的url。
           */
          path: {
            type: String,
            notify: true,
            observer: '_observePath'
          }
        },

        attached() {
          if(this.$.selector.selected === '' || this.path === '/') {
            this.path = '/main';
          }

          this.addEventListener('ms-music-play', (e) => {
            this.$.player.style.display = 'block';

            this.$.player.src = e.detail.mp3Url;
            this.$.player.musicName = e.detail.name + ' - ' + e.detail.singer;
            this.$.player.play();
          })

          this.addEventListener('ms-search', (e) => {
            this.path = '/search';
            this.$.search.search(e.detail.s, "0", "20", "1");
          });

          this.addEventListener('ms-search-albums', (e) => {
            this.$.search.search(e.detail.s, "0", "20", "10");
          });

          this._initLogoutListen();
          let user = this.$.localUser.getUser();
          this.user = user;
        },

        _observePath(path) {
          if(path === '/musicDetail') {
            this.$.musicDetail.refresh();
          }

          if(path === '/diskDetail') {
            this.$.diskDetail.refresh();
          }
        },

        _initLogoutListen() {
          window.addEventListener('logout', () => {
            this.user = null;
            this.$.localUser.clearUser();
          });
        }
      });
   })();
  </script>
</dom-module>
